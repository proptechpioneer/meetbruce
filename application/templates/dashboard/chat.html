{% extends "layout.html" %}
{% load static %}

{% block title %}Chat with Bruce | AI Powered Tenant Advocate{% endblock %}

{% block content %}
    <div class="h-screen flex items-center justify-center px-4 py-4">
        <div class="max-w-4xl mx-auto h-full flex items-center">
            <!-- Chat Interface -->
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden max-h-[85vh] w-full flex flex-col">
                <!-- Header -->
                <div class="bg-linear-to-r from-blue-600 to-blue-800 text-white p-6 shrink-0">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-blue-200 rounded-full flex items-center justify-center">
                                <span class="text-2xl font-bold text-blue-800">B</span>
                            </div>
                            <div>
                                <h1 class="text-2xl font-bold">Chat with Bruce</h1>
                                <p class="text-blue-100">Your AI-Powered Tenant Advocate</p>
                                <div class="flex items-center mt-1">
                                    <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                    <span class="text-sm text-blue-100 ml-2">Online</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Back to Dashboard Button -->
                        <a href="{% url 'dashboard:home' %}" 
                           class="inline-flex items-center space-x-2 bg-blue-700 hover:bg-blue-800 text-white font-medium py-2 px-4 rounded-lg transition duration-300 ease-in-out">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                            <span>Dashboard</span>
                        </a>
                    </div>
                </div>

                <!-- Chat Container -->
                <div id="chat-container" class="p-6 bg-gray-50 flex-1 overflow-y-auto min-h-0">
                    
                    <!-- Welcome Message -->
                    <div class="flex items-start space-x-3 mb-6">
                        <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center shrink-0">
                            <span class="text-white text-sm font-bold">B</span>
                        </div>
                        <div class="bg-white rounded-2xl rounded-tl-sm shadow-sm p-4 max-w-md">
                            <p class="text-gray-800 text-base leading-relaxed">
                                Hello {{ user.name|default:user.username }}! üëã I'm Bruce, your AI-powered tenant advocate. How can I help you today?
                            </p>
                        </div>
                    </div>

                    <!-- Suggested Questions -->
                    <div class="mb-6">
                        <div class="flex items-start space-x-3 mb-3">
                            <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center shrink-0">
                                <span class="text-white text-sm font-bold">B</span>
                            </div>
                            <div class="bg-white rounded-2xl rounded-tl-sm shadow-sm p-4 max-w-md">
                                <p class="text-gray-800 text-base leading-relaxed mb-3">
                                    Here are some things I can help you with:
                                </p>
                            </div>
                        </div>
                        
                        <!-- Quick Action Buttons -->
                        <div class="ml-11 space-y-2">
                            <button class="suggestion-btn block w-full max-w-md text-left bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded-lg p-3 transition duration-200 ease-in-out">
                                <span class="text-blue-800 font-medium">üìã Check if my landlord is compliant with regulations</span>
                            </button>
                            
                            <button class="suggestion-btn block w-full max-w-md text-left bg-green-50 hover:bg-green-100 border border-green-200 rounded-lg p-3 transition duration-200 ease-in-out">
                                <span class="text-green-800 font-medium">üí∞ Review my rent and compare market rates</span>
                            </button>
                            
                            <button class="suggestion-btn block w-full max-w-md text-left bg-red-50 hover:bg-red-100 border border-red-200 rounded-lg p-3 transition duration-200 ease-in-out">
                                <span class="text-red-800 font-medium">üîß Report a property issue or maintenance request</span>
                            </button>
                            
                            <button class="suggestion-btn block w-full max-w-md text-left bg-purple-50 hover:bg-purple-100 border border-purple-200 rounded-lg p-3 transition duration-200 ease-in-out">
                                <span class="text-purple-800 font-medium">‚öñÔ∏è Understand my rights as a tenant</span>
                            </button>
                            
                            <button class="suggestion-btn block w-full max-w-md text-left bg-yellow-50 hover:bg-yellow-100 border border-yellow-200 rounded-lg p-3 transition duration-200 ease-in-out">
                                <span class="text-yellow-800 font-medium">üìú Help with lease terms and negotiations</span>
                            </button>
                        </div>
                    </div>

                    <!-- Messages will be added here dynamically -->
                    <div id="messages-area">
                        <!-- Dynamic chat messages will appear here -->
                    </div>
                </div>

                <!-- Chat Input -->
                <div class="bg-white border-t border-gray-200 p-4 shrink-0">
                    <div class="flex items-center space-x-3">
                        <div class="flex-1">
                            <div class="relative">
                                <input 
                                    type="text" 
                                    id="chat-input" 
                                    placeholder="Type your message here..."
                                    class="w-full py-3 px-4 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                    maxlength="1000">
                                <button 
                                    id="send-btn"
                                    class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg transition duration-200 ease-in-out">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Typing indicator -->
                    <div id="typing-indicator" class="hidden mt-2 text-sm text-gray-500">
                        <div class="flex space-x-1 mr-2">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                        </div>
                        <span>Bruce is typing...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for Chat Functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-btn');
            const messagesArea = document.getElementById('messages-area');
            const typingIndicator = document.getElementById('typing-indicator');
            const suggestionBtns = document.querySelectorAll('.suggestion-btn');

            // Handle suggestion button clicks
            suggestionBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const text = this.querySelector('span').textContent.replace(/^[^\s]+\s/, ''); // Remove emoji
                    chatInput.value = text;
                    sendMessage();
                });
            });

            // Handle send button click
            sendBtn.addEventListener('click', sendMessage);

            // Handle enter key press
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            function sendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;

                // Add user message
                addMessage(message, 'user');
                chatInput.value = '';

                // Show typing indicator
                showTypingIndicator();

                // Simulate Bruce's response (replace with actual AI integration)
                setTimeout(() => {
                    hideTypingIndicator();
                    addMessage("Thanks for your question! I'm currently being developed to provide comprehensive tenant advocacy. In the meantime, you can use the Report an Issue feature from your dashboard to document any property concerns, or check out the Rental Insights to review your rent.", 'bruce');
                }, 1500);
            }

            function addMessage(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex items-start space-x-3 mb-4';

                if (sender === 'user') {
                    messageDiv.innerHTML = `
                        <div class="flex items-start space-x-3 mb-4 flex-row-reverse">
                            <div class="w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center shrink-0">
                                <span class="text-white text-sm font-bold">${'{{ user.name|default:user.username|first|upper }}'}</span>
                            </div>
                            <div class="bg-blue-600 text-white rounded-2xl rounded-tr-sm shadow-sm p-4 max-w-md">
                                <p class="text-base leading-relaxed">${text}</p>
                            </div>
                        </div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center shrink-0">
                            <span class="text-white text-sm font-bold">B</span>
                        </div>
                        <div class="bg-white rounded-2xl rounded-tl-sm shadow-sm p-4 max-w-md">
                            <p class="text-gray-800 text-base leading-relaxed">${text}</p>
                        </div>
                    `;
                }

                messagesArea.appendChild(messageDiv);
                messagesArea.scrollIntoView({ behavior: 'smooth', block: 'end' });
            }

            function showTypingIndicator() {
                typingIndicator.classList.remove('hidden');
                typingIndicator.classList.add('flex', 'items-center');
            }

            function hideTypingIndicator() {
                typingIndicator.classList.add('hidden');
                typingIndicator.classList.remove('flex', 'items-center');
            }
        });
    </script>
{% endblock %}